{% extends "cms_app/backend/base.html" %}
{% load cms_tags %}

{% block title %}Edit: {{ page.title }}{% endblock %}
{% block page_title %}Edit Page{% endblock %}

{% block extra_css %}
<style>
    /* Editor Specific Styles */
    .editor-container {
        background: white;
        border-radius: 10px;
        overflow: hidden;
    }

    .editor-toolbar {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .editor-canvas {
        padding: 2rem;
        min-height: 500px;
    }

    /* Section Editing */
    .editable-section {
        position: relative;
        margin-bottom: 2rem;
        border: 2px dashed transparent;
        transition: all 0.3s;
        padding: 1rem;
        border-radius: 8px;
    }

    .editable-section:hover {
        border-color: #4361ee;
        background-color: rgba(67, 97, 238, 0.02);
    }

    .editable-section.dragging {
        opacity: 0.5;
    }

    .section-toolbar {
        position: absolute;
        top: -10px;
        right: 10px;
        display: none;
        gap: 0.5rem;
        z-index: 100;
    }

    .editable-section:hover .section-toolbar {
        display: flex;
    }

    .section-handle {
        cursor: move;
        padding: 0.5rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Content Block Editing */
    .editable-block {
        position: relative;
        border: 1px dashed transparent;
        padding: 0.5rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .editable-block:hover {
        border-color: #06d6a0;
        background-color: rgba(6, 214, 160, 0.02);
    }

    .block-toolbar {
        position: absolute;
        top: -10px;
        right: 5px;
        display: none;
        gap: 0.25rem;
        z-index: 99;
    }

    .editable-block:hover .block-toolbar {
        display: flex;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
    }

    /* Add Section Button */
    .add-section-zone {
        padding: 2rem;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 2rem;
        transition: all 0.3s;
    }

    .add-section-zone:hover {
        border-color: #4361ee;
        background-color: rgba(67, 97, 238, 0.05);
    }

    /* Modals */
    .modal-content {
        border-radius: 10px;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    /* Preview Mode */
    .preview-mode .section-toolbar,
    .preview-mode .block-toolbar,
    .preview-mode .add-section-zone {
        display: none !important;
    }

    .preview-mode .editable-section,
    .preview-mode .editable-block {
        border-color: transparent !important;
    }

    /* Save Indicator */
    .save-indicator {
        display: none;
        align-items: center;
        gap: 0.5rem;
        color: #06d6a0;
    }

    .save-indicator.saving {
        display: flex;
        color: #ffd166;
    }

    .save-indicator.saved {
        display: flex;
    }

    .save-indicator.error {
        display: flex;
        color: #ef476f;
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <!-- Editor Toolbar -->
    <div class="editor-toolbar">
        <div>
            <h4 class="mb-0">{{ page.title }}</h4>
            <small class="text-muted">Last updated: {{ page.updated_at|date:"M d, Y H:i" }}</small>
        </div>

        <div class="d-flex align-items-center gap-2 flex-wrap">
            <!-- Save Indicator -->
            <div class="save-indicator" id="saveIndicator">
                <span class="spinner-border spinner-border-sm"></span>
                <span id="saveText">Saving...</span>
            </div>

            <!-- Actions -->
            <button type="button" class="btn btn-outline-secondary" onclick="togglePreview()">
                <i class="bi bi-eye"></i> <span id="previewText">Preview</span>
            </button>

            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#pageSettingsModal">
                <i class="bi bi-gear"></i> Page Settings
            </button>

            <div class="btn-group">
                <button type="button" class="btn btn-success" onclick="savePage('published')">
                    <i class="bi bi-check-circle"></i> Publish
                </button>
                <button type="button" class="btn btn-warning" onclick="savePage('draft')">
                    <i class="bi bi-save"></i> Save Draft
                </button>
            </div>

            <a href="{% url 'backend_page_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Pages
            </a>
        </div>
    </div>

    <!-- Editor Canvas -->
    <div class="editor-canvas" id="editorCanvas">
        {% if sections %}
            {% for section in sections %}
            <div class="editable-section" data-section-id="{{ section.id }}" data-order="{{ section.order }}">
                <!-- Section Toolbar -->
                <div class="section-toolbar">
                    <button class="btn btn-sm btn-light section-handle" title="Drag to reorder">
                        <i class="bi bi-grip-vertical"></i>
                    </button>
                    <button class="btn btn-sm btn-primary btn-icon" onclick="editSection({{ section.id }})" title="Edit Section">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-success btn-icon" onclick="addBlock({{ section.id }})" title="Add Content Block">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-icon" onclick="deleteSection({{ section.id }})" title="Delete Section">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>

                <!-- Section Content -->
                <div class="section-content" style="{% if section.background_color %}background-color: {{ section.background_color }};{% endif %} {% if section.text_color %}color: {{ section.text_color }};{% endif %} padding: {{ section.padding_top|default:'20' }}px 20px {{ section.padding_bottom|default:'20' }}px;">
                    {% if section.title %}
                    <h3>{{ section.title }}</h3>
                    {% endif %}

                    <!-- Content Blocks -->
                    {% for block in section.content_blocks.all %}
                    <div class="editable-block" data-block-id="{{ block.id }}" data-order="{{ block.order }}">
                        <!-- Block Toolbar -->
                        <div class="block-toolbar">
                            <button class="btn btn-sm btn-light btn-icon" title="Drag to reorder">
                                <i class="bi bi-grip-vertical"></i>
                            </button>
                            <button class="btn btn-sm btn-info btn-icon" onclick="editBlock({{ block.id }})" title="Edit Block">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-icon" onclick="deleteBlock({{ block.id }})" title="Delete Block">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>

                        <!-- Block Content -->
                        {% render_content_block block %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-layout-text-window-reverse" style="font-size: 4rem; color: #ccc;"></i>
                <p class="text-muted mt-3 mb-4">This page has no sections yet. Add your first section to get started!</p>
            </div>
        {% endif %}

        <!-- Add Section Button -->
        <div class="add-section-zone" onclick="showAddSectionModal()">
            <i class="bi bi-plus-circle" style="font-size: 2rem; color: #4361ee;"></i>
            <p class="mt-2 mb-0"><strong>Click to Add New Section</strong></p>
        </div>
    </div>
</div>

<!-- Page Settings Modal -->
<div class="modal fade" id="pageSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Page Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="pageSettingsForm">
                    <div class="mb-3">
                        <label class="form-label">Page Title</label>
                        <input type="text" class="form-control" id="pageTitle" value="{{ page.title }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL Slug</label>
                        <input type="text" class="form-control" id="pageSlug" value="{{ page.slug }}">
                        <small class="text-muted">URL: /{{ page.slug }}/</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Meta Title (SEO)</label>
                        <input type="text" class="form-control" id="metaTitle" value="{{ page.meta_title|default:'' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Meta Description (SEO)</label>
                        <textarea class="form-control" id="metaDescription" rows="3">{{ page.meta_description|default:'' }}</textarea>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="isHome" {% if page.is_home %}checked{% endif %}>
                        <label class="form-check-label" for="isHome">Set as Homepage</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="savePageSettings()">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Section Modal -->
<div class="modal fade" id="sectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sectionModalTitle">Add Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sectionForm">
                    <input type="hidden" id="sectionId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Section Type</label>
                            <select class="form-select" id="sectionType">
                                {% for value, label in section_types %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="sectionTitle">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Background Color</label>
                            <input type="color" class="form-control form-control-color" id="sectionBgColor" value="#ffffff">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Text Color</label>
                            <input type="color" class="form-control form-control-color" id="sectionTextColor" value="#000000">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Padding Top (px)</label>
                            <input type="number" class="form-control" id="sectionPaddingTop" value="20">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Padding Bottom (px)</label>
                            <input type="number" class="form-control" id="sectionPaddingBottom" value="20">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="sectionVisible" checked>
                        <label class="form-check-label" for="sectionVisible">Visible on site</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveSection()">Save Section</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Content Block Modal -->
<div class="modal fade" id="blockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blockModalTitle">Add Content Block</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="blockForm">
                    <input type="hidden" id="blockId">
                    <input type="hidden" id="blockSectionId">
                    <div class="mb-3">
                        <label class="form-label">Block Type</label>
                        <select class="form-select" id="blockType">
                            {% for value, label in block_types %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title (optional)</label>
                        <input type="text" class="form-control" id="blockTitle">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea class="form-control" id="blockContent" rows="5"></textarea>
                        <small class="text-muted">Supports HTML for rich formatting</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link URL (for buttons/links)</label>
                        <input type="url" class="form-control" id="blockLinkUrl" placeholder="https://example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link Text (for buttons)</label>
                        <input type="text" class="form-control" id="blockLinkText" placeholder="Click here">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveBlock()">Save Block</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
const pageId = {{ page.id }};
let previewMode = false;

// Initialize Sortable for sections
const editorCanvas = document.getElementById('editorCanvas');
const sectionsSortable = Sortable.create(editorCanvas, {
    handle: '.section-handle',
    animation: 150,
    ghostClass: 'dragging',
    onEnd: function() {
        reorderSections();
    }
});

// Save page with status
function savePage(status) {
    showLoading();

    const data = {
        status: status
    };

    fetchWithCSRF(`/backend/api/pages/${pageId}/save/`, {
        method: 'POST',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast(`Page ${status === 'published' ? 'published' : 'saved as draft'} successfully`, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(data.error || 'Failed to save page', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('An error occurred', 'danger');
        console.error('Error:', error);
    });
}

// Save page settings
function savePageSettings() {
    const data = {
        title: document.getElementById('pageTitle').value,
        slug: document.getElementById('pageSlug').value,
        meta_title: document.getElementById('metaTitle').value,
        meta_description: document.getElementById('metaDescription').value,
        is_home: document.getElementById('isHome').checked
    };

    showLoading();

    fetchWithCSRF(`/backend/api/pages/${pageId}/save/`, {
        method: 'POST',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast('Settings saved successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('pageSettingsModal')).hide();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(data.error || 'Failed to save settings', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('An error occurred', 'danger');
        console.error('Error:', error);
    });
}

// Add new section
function showAddSectionModal() {
    document.getElementById('sectionModalTitle').textContent = 'Add New Section';
    document.getElementById('sectionId').value = '';
    document.getElementById('sectionForm').reset();
    new bootstrap.Modal(document.getElementById('sectionModal')).show();
}

// Save section
function saveSection() {
    const sectionId = document.getElementById('sectionId').value;
    const isEdit = sectionId !== '';

    const data = {
        section_type: document.getElementById('sectionType').value,
        title: document.getElementById('sectionTitle').value,
        background_color: document.getElementById('sectionBgColor').value,
        text_color: document.getElementById('sectionTextColor').value,
        padding_top: document.getElementById('sectionPaddingTop').value,
        padding_bottom: document.getElementById('sectionPaddingBottom').value,
        is_visible: document.getElementById('sectionVisible').checked
    };

    showLoading();

    const url = isEdit
        ? `/backend/api/sections/${sectionId}/update/`
        : `/backend/api/pages/${pageId}/sections/create/`;

    fetchWithCSRF(url, {
        method: 'POST',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast(`Section ${isEdit ? 'updated' : 'created'} successfully`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('sectionModal')).hide();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(data.error || 'Failed to save section', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('An error occurred', 'danger');
        console.error('Error:', error);
    });
}

// Edit section
function editSection(sectionId) {
    // Note: In a full implementation, you'd fetch section data via AJAX
    document.getElementById('sectionModalTitle').textContent = 'Edit Section';
    document.getElementById('sectionId').value = sectionId;
    new bootstrap.Modal(document.getElementById('sectionModal')).show();
}

// Delete section
function deleteSection(sectionId) {
    if (!confirm('Are you sure you want to delete this section and all its content blocks?')) {
        return;
    }

    showLoading();

    fetchWithCSRF(`/backend/api/sections/${sectionId}/delete/`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast('Section deleted successfully', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(data.error || 'Failed to delete section', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('An error occurred', 'danger');
        console.error('Error:', error);
    });
}

// Reorder sections
function reorderSections() {
    const sections = document.querySelectorAll('.editable-section');
    const sectionOrders = Array.from(sections).map((section, index) => ({
        id: parseInt(section.dataset.sectionId),
        order: index
    }));

    fetchWithCSRF(`/backend/api/pages/${pageId}/sections/reorder/`, {
        method: 'POST',
        body: JSON.stringify({ sections: sectionOrders })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Sections reordered', 'success');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Add content block
function addBlock(sectionId) {
    document.getElementById('blockModalTitle').textContent = 'Add Content Block';
    document.getElementById('blockId').value = '';
    document.getElementById('blockSectionId').value = sectionId;
    document.getElementById('blockForm').reset();
    new bootstrap.Modal(document.getElementById('blockModal')).show();
}

// Save content block
function saveBlock() {
    const blockId = document.getElementById('blockId').value;
    const sectionId = document.getElementById('blockSectionId').value;
    const isEdit = blockId !== '';

    const data = {
        block_type: document.getElementById('blockType').value,
        title: document.getElementById('blockTitle').value,
        content: document.getElementById('blockContent').value,
        link_url: document.getElementById('blockLinkUrl').value,
        link_text: document.getElementById('blockLinkText').value
    };

    showLoading();

    const url = isEdit
        ? `/backend/api/blocks/${blockId}/update/`
        : `/backend/api/sections/${sectionId}/blocks/create/`;

    fetchWithCSRF(url, {
        method: 'POST',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast(`Content block ${isEdit ? 'updated' : 'created'} successfully`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('blockModal')).hide();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(data.error || 'Failed to save content block', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('An error occurred', 'danger');
        console.error('Error:', error);
    });
}

// Edit content block
function editBlock(blockId) {
    document.getElementById('blockModalTitle').textContent = 'Edit Content Block';
    document.getElementById('blockId').value = blockId;
    new bootstrap.Modal(document.getElementById('blockModal')).show();
}

// Delete content block
function deleteBlock(blockId) {
    if (!confirm('Are you sure you want to delete this content block?')) {
        return;
    }

    showLoading();

    fetchWithCSRF(`/backend/api/blocks/${blockId}/delete/`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast('Content block deleted successfully', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(data.error || 'Failed to delete content block', 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('An error occurred', 'danger');
        console.error('Error:', error);
    });
}

// Toggle preview mode
function togglePreview() {
    previewMode = !previewMode;
    const canvas = document.getElementById('editorCanvas');
    const previewText = document.getElementById('previewText');

    if (previewMode) {
        canvas.classList.add('preview-mode');
        previewText.textContent = 'Edit Mode';
    } else {
        canvas.classList.remove('preview-mode');
        previewText.textContent = 'Preview';
    }
}
</script>
{% endblock %}
